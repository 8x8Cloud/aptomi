# Definition of Twitter Analytics service
name: twitter-stats

components:

  - name: analytics_pipeline
    service: analytics_pipeline

  # Publisher (Twitter Streaming API -> kafka)
  - name: tweepub
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweepub-1.0.0
      params:
        cluster: "{{ .Labels.cluster }}"

        # Pass labels to publisher application
        twitter:
          appKey: "{{ .Labels.appKey }}"
          appSecret: "{{ .Labels.appSecret }}"
          tokenKey: "{{ .Labels.tokenKey }}"
          tokenSecret: "{{ .Labels.tokenSecret }}"
          locations: "{{ .Labels.locations }}"

        # Tell publisher where to put messages (kafka connection url & topic)
        kafka:
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.kafka.url }}"
          topic: "tweepub-{{ .User.Name }}"
    dependencies:
      - analytics_pipeline

  # Spark job (takes tweets -> does hashtags stats -> puts stats into hdfs)
  - name: tweetics
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweetics-0.1.0
      params:
        cluster: "{{ .Labels.cluster }}"

        zookeeper:
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.zookeeper.zookeeper.url }}"

        kafka:
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.kafka.url }}"
          topic: "tweepub-{{ .User.Name }}"

        spark:
          externalAddress: "{{ .Discovery.analytics_pipeline.spark.spark.url }}"

        hdfs:
          externalAddress: "{{ .Discovery.analytics_pipeline.hdfs.hdfs.url }}"
          path: "/twitter-{{ .User.Name }}/results"
    dependencies:
      - analytics_pipeline

  # Visualizer (takes stats from hdfs and shows on web page)
  - name: tweeviz
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweeviz-0.1.0
      params:
        cluster: "{{ .Labels.cluster }}"

        image:
          repository: frostman/tweeviz
          tag: "{{ .Labels.tsvisimage }}"

#        topListSize: 25

        header: Twitter Stats {{ .User.Name }} ({{ .Discovery.instance }})

        hdfs:
          externalAddress: "{{ .Discovery.analytics_pipeline.hdfs.hdfs.url }}"
          path: "/twitter-{{ .User.Name }}"
    dependencies:
      - analytics_pipeline
