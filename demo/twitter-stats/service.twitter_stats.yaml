# Definition of Twitter Analytics service
name: twitter-stats

components:

  - name: analytics_pipeline
    service: analytics_pipeline

  - name: tweepub
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweepub-1.0.0
      params:
        image:
          repository: frostman/tweepub
          tag: 1.0.0

        twitter:
          appKey: "{{ .Labels.appKey }}"
          appSecret: "{{ .Labels.appSecret }}"
          tokenKey: "{{ .Labels.tokenKey }}"
          tokenSecret: "{{ .Labels.tokenSecret }}"

          locations: "{{ .Labels.locations }}"

        kafka:
          deployChart: false
          externalAddress: kafka-{{ .Components.analytics_pipeline.kafka.kafka }}-0.kafka-{{ .Components.analytics_pipeline.kafka.kafka }}:9092
          topic: tweepub_{{ .User.Name }}
    dependencies:
      - analytics_pipeline

  - name: tweetics
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweetics-0.1.0
      params:
        image:
          repository: frostman/tweetics
          tag: 1.0.0

        minHashtagCounts: 0

        zookeeper:
          deployChart: false
          externalAddress: zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}-0.zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}:2181

        kafka:
          deployChart: false
          externalAddress: kafka-{{ .Components.analytics_pipeline.kafka.kafka }}-0.kafka-{{ .Components.analytics_pipeline.kafka.kafka }}:9092
          topic: tweepub_{{ .User.Name }}
          zookeeper:
            deployChart: false
            externalAddress: zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}-0.zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}:2181

        spark:
          deployChart: false
          externalAddress: spark-master-{{ .Components.analytics_pipeline.spark.spark }}-0.spark-master-{{ .Components.analytics_pipeline.spark.spark }}:7077
          zookeeper:
            deployChart: false
            externalAddress: zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}-0.zk-{{ .Components.analytics_pipeline.kafka.zookeeper.zookeeper }}:2181
        hdfs:
          deployChart: false
          externalAddress: hdfs-namenode-{{ .Components.analytics_pipeline.hdfs.hdfs }}-0.hdfs-namenode-{{ .Components.analytics_pipeline.hdfs.hdfs }}
          path: /twitter-{{ .User.Name }}/results
    dependencies:
      - analytics_pipeline

  - name: tweeviz
    code:
      type: aptomi/code/kubernetes-helm
      metadata:
        chartName: tweeviz-0.1.0
      params:
        image:
          repository: frostman/tweeviz
          tag: 1.0.0

        minPopularity: 0
        topListSize: 25

        service:
          type: NodePort

        hdfs:
          deployChart: false
          externalAddress: hdfs-namenode-{{ .Components.analytics_pipeline.hdfs.hdfs }}-0.hdfs-namenode-{{ .Components.analytics_pipeline.hdfs.hdfs }}
          path: /twitter-{{ .User.Name }}
    dependencies:
      - analytics_pipeline
