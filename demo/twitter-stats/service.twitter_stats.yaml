# Definition of Twitter Analytics service
name: twitter-stats

components:

  - name: analytics_pipeline
    service: analytics_pipeline

  # Publisher (Twitter Streaming API -> kafka)
  - name: tweepub
    code:
      type: aptomi/code/kubernetes-helm
      cluster: demo
      metadata:
        chartName: tweepub-1.0.0
      params:
        image:
          repository: frostman/tweepub
          tag: 1.0.0

        # Pass labels to publisher application
        twitter:
          appKey: "{{ .Labels.appKey }}"
          appSecret: "{{ .Labels.appSecret }}"
          tokenKey: "{{ .Labels.tokenKey }}"
          tokenSecret: "{{ .Labels.tokenSecret }}"
          locations: "{{ .Labels.locations }}"

        # Tell publisher where to put messages (kafka connection url & topic)
        kafka:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.kafka.url }}"
          topic: "tweepub-{{ .User.Name }}"
    dependencies:
      - analytics_pipeline

  # Spark job (takes tweets -> does hashtags stats -> puts stats into hdfs)
  - name: tweetics
    code:
      type: aptomi/code/kubernetes-helm
      cluster: demo
      metadata:
        chartName: tweetics-0.1.0
      params:
        image:
          repository: frostman/tweetics
          tag: 1.0.0

        minHashtagCounts: 0

        zookeeper:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.zookeeper.zookeeper.url }}"

        kafka:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.kafka.kafka.url }}"
          topic: "tweepub-{{ .User.Name }}"
          zookeeper:
            deployChart: false
            externalAddress: "{{ .Discovery.analytics_pipeline.kafka.zookeeper.zookeeper.url }}"

        spark:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.spark.spark.url }}"
          zookeeper:
            deployChart: false
            externalAddress: "{{ .Discovery.analytics_pipeline.spark.zookeeper.zookeeper.url }}"

        hdfs:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.hdfs.hdfs.url }}"
          path: "/twitter-{{ .User.Name }}/results"
    dependencies:
      - analytics_pipeline

  # Visualizer (takes stats from hdfs and shows on web page)
  - name: tweeviz
    code:
      type: aptomi/code/kubernetes-helm
      cluster: demo
      metadata:
        chartName: tweeviz-0.1.0
      params:
        image:
          repository: frostman/tweeviz
          tag: 1.0.0

        minPopularity: 0
        topListSize: 25

        service:
          type: NodePort

        hdfs:
          deployChart: false
          externalAddress: "{{ .Discovery.analytics_pipeline.hdfs.hdfs.url }}"
          path: "/twitter-{{ .User.Name }}"
    dependencies:
      - analytics_pipeline
