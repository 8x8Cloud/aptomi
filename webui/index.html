<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Aptomi | Home</title>

    <link href="public/css/bootstrap.min.css" rel="stylesheet">
    <link href="public/font-awesome/css/font-awesome.css" rel="stylesheet">

    <link href="public/css/animate.css" rel="stylesheet">
    <link href="public/css/style.css" rel="stylesheet">

    <link href="public/vis/dist/vis-network.min.css" rel="stylesheet" type="text/css"/>

    <style>
        #mygraph {
            color: #d3d3d3;
            background-color: #222222;
            border: 1px solid #444444;
            font: 12pt arial;
            width: 100%;
            height: 435px;
        }
    </style>

    <link href="/favicon.ico?v=42" rel="icon">

</head>

<body class="top-navigation">

<!--Main body, usually don't need to change-->
<div id="wrapper">
    <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom white-bg">
            <nav class="navbar navbar-static-top" role="navigation">
                <div class="navbar-header">
                    <button aria-controls="navbar" aria-expanded="false" data-target="#navbar" data-toggle="collapse" class="navbar-toggle collapsed" type="button">
                        <i class="fa fa-reorder"></i>
                    </button>
                    <a href="#" class="navbar-brand" style="padding: 5px 5px">
                        <img src="public/img/aptomi_logo_2.png" style="height: 40px">
                    </a>
                </div>
                <div class="navbar-collapse collapse" id="navbar">
                    <ul class="nav navbar-nav">
                        <router-link v-for="item in routes" v-bind:to="item.path" tag="li">
                            <a role="button"> {{ item.title }}</a>
                        </router-link>
                    </ul>
                    <ul class="nav navbar-top-links navbar-right">
                        <li>
                            <a href="#">
                                <i class="fa"></i> [TODO: Select Run]
                            </a>
                        </li>
                        <li>
                            <a href="#">
                                <i class="fa"></i> User: <span>{{ user.name }}</span>
                            </a>
                        </li>
                        <li>
                            <a href="/api/logout?redirect=/ui/login.html">
                                <i class="fa fa-sign-out"></i> Log out
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>
        </div>
        <div class="wrapper wrapper-content">
            <div class="container">
                <router-view></router-view>
            </div>
        </div>
        <div class="footer">
            <!--<div class="pull-right">-->
                <!--10GB of <strong>250GB</strong> Free.-->
            <!--</div>-->
            <div>
                <strong>Copyright</strong> Aptomi &copy; 2017
            </div>
        </div>

    </div>
</div>

<!--JS-->
<!-- Mainly scripts -->
<script src="public/js/jquery-3.1.1.min.js"></script>
<script src="public/js/bootstrap.min.js"></script>
<script src="public/js/plugins/metisMenu/jquery.metisMenu.js"></script>
<script src="public/js/plugins/slimscroll/jquery.slimscroll.min.js"></script>

<!-- Custom and plugin javascript -->
<script src="public/js/inspinia.js"></script>
<script src="public/js/plugins/pace/pace.min.js"></script>

<script src="public/js/vue.min.js"></script>
<script src="public/js/vue-router.min.js"></script>

<script src="public/js/js.cookie-2.1.4.min.js"></script>

<script type="text/javascript" src="public/vis/dist/vis.js"></script>
<script type="text/javascript" src="public/vis/dist/vis-util.js"></script>

<!--Template for /details filter-->
<script type="text/x-template" id="template-details-filter">
    <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <span>{{ current_title.length != 0 ? current_title : 'Not available' }}</span>
            &nbsp;
            <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
            <router-link v-for="item in items"
                         v-bind:to="{ name: 'details', params: { view: target_view.length == 0 ? item.name : target_view, filter: target_view.length != 0 ? item.name : ':filter' } }"
                         tag="li">
                <a> {{ item.title }}</a>
            </router-link>
        </ul>
    </div>
</script>

<!--JS for /details/filter-->
<script>
    const CompDetailsFilter = Vue.component('details-filter', {
        template: '#template-details-filter',
        props: ['items', 'current_title', 'target_view']
    })
</script>

<!--Template for /details-->
<script type="text/x-template" id="template-details">
    <div class="row">
        <div class="col-lg-9">
            <div class="ibox float-e-margins">
                <div class="ibox-content">
                    <div class="row m-b-xs">
                        <div class="col-sm-12">
                            <!--<span class="m-l-xs m-r-sm">View Type: </span>-->
                            <details-filter v-bind:items="views" v-bind:current_title="curr_view_title" target_view=""/>

                            <span v-if="items.length > 0" class="m-l-sm m-r-sm">{{ filter_name }}: </span>
                            <details-filter v-if="items.length > 0"
                                            v-bind:items="items" v-bind:current_title="curr_filter_title" v-bind:target_view="curr_view"/>

                        </div>
                    </div>
                    <div id="mygraph"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Details</h5>
                </div>
                <div class="ibox-content">
                    <div id="mypanel">No data loaded</div>
                </div>
            </div>
        </div>
    </div>
</script>

<!--JS for drawing charts on /details-->
<script>
    const drawChart = function (inputView, userId, dependencyId, serviceName) {
        console.log("Draw chart with params: ")
        console.log(inputView)
        console.log(userId)
        console.log(dependencyId)
        console.log(serviceName)
        console.log("==== Draw")

        // can be service-view, consumer-view, or globalops-view
        var view = inputView + "-view";

        var apiPath = "/api/" + view;
        if (view === "service-view") {
            // service-view = view from the standpoint of service owner
//            var serviceName = "analytics_pipeline";
            apiPath += "?serviceName=" + serviceName;
        } else if (view === "consumer-view") {
            // consumer-view = view from the standpoint of service consumer
//            var userId = "100";
//            var dependencyId = "" //"alice_tests_twitter_stats_in_stage"; // if you pass dependencyId, it will filter. if you don't, it will show all dependencies of a given user
            apiPath += "?userId=" + userId + "&dependencyId=" + dependencyId;
        } else {
            // globalops-view = view from the standpoint of global IT ops
//            var userId = "100";
            apiPath += "?userId=" + userId;
        }

        loadJSON(apiPath, jsonLoaded, function (err) {
            console.log('error')
        });

        // create a network
        var container = document.getElementById('mygraph');
        var options = {
            nodes: {
                font: {
                    size: 12,
                    color: 'white'
                },
                borderWidth: 2,
                chosen: {
                    label: false,
                    node: chosenNode
                }
            },
            edges: {
                width: 1,
                font: {
                    size: 12,
                    strokeWidth: 0,
                    color: 'white',
                    align: 'top'
                }
            },
            groups: {
                service: {
                    shape: 'icon',
                    icon: {
                        face: 'FontAwesome',
                        code: '\uf1b2',
                        size: 50,
                        color: 'red'
                    },
                    color: {
                        border: 'red'
                    }
                },
                serviceInstancePrimary: {
                    font: {
                        color: 'black',
                        multi: 'html'
                    },
                    color: {background: 'rgb(0,255,140)', border: 'darkslategrey'},
                    shape: 'box'
                },
                serviceInstance: {
                    font: {
                        color: 'black',
                        multi: 'html'
                    },
                    color: {background: 'rgb(0,123,199)', border: 'darkslategrey'},
                    shape: 'box'
                },
                dependencyShort: {
                    shape: 'icon',
                    icon: {
                        face: 'FontAwesome',
                        code: '\uf007',
                        size: 50,
                        color: 'orange'
                    }
                },
                dependencyLongResolved: {
                    shape: 'icon',
                    font: {
                        multi: 'html',
                    },
                    icon: {
                        face: 'FontAwesome',
                        code: '\uf234',
                        size: 50,
                        color: 'orange'
                    }
                },
                dependencyLongNotResolved: {
                    shape: 'icon',
                    font: {
                        multi: 'html'
                    },
                    icon: {
                        face: 'FontAwesome',
                        code: '\uf235',
                        size: 50,
                        color: 'red'
                    }
                },
                mints: {color: 'rgb(0,255,140)'},
                source: {
                    color: {border: 'white'}
                }
            },
            layout: {
                randomSeed: 239,
                hierarchical: {
                    direction: "LR",
                    levelSeparation: 220
                }
            },
            interaction: {
                hover: true
            },
            physics: false
        };

        // hack to better display consumer view
        if (view === "consumer-view") {
            options.layout.hierarchical.levelSeparation = 130;
        }

        function chosenNode(values, id, selected, hovering) {
            values.color = "#ffdd88";
            values.borderColor = "#ff0000";
        }

        function clickedNode(params) {
            params.event = "[original event]";
            var node = this.getNodeAt(params.pointer.DOM);
            var edge = this.getEdgeAt(params.pointer.DOM);

            var id = "";
            if (node) {
                id = node
            } else if (edge) {
                id = edge
            }
            if (id) {
                loadJSON("/api/object-view?id=" + id, objectLoaded, objectNotLoaded);
            } else {
                document.getElementById('mypanel').innerHTML = 'No data loaded'
            }
        }

        function jsonLoaded(jsonData) {
            var data = {
                nodes: jsonData.nodes,
                edges: jsonData.edges
            };

            network = new vis.Network(container, data, options);
            network.on("click", clickedNode);
            network.fit();
        }

        function objectLoaded(jsonData) {
            if (jsonData) {
                document.getElementById('mypanel').innerHTML = '<pre>' + JSON.stringify(jsonData, null, 4) + '</pre>';
            } else {
                document.getElementById('mypanel').innerHTML = 'No data loaded'
            }
        }

        function objectNotLoaded(err) {
            document.getElementById('mypanel').innerHTML = '<h2>Unable to load data</h2>' + err
        }
    };
</script>

<!--JS for /details-->
<script>
    const CompDetails = Vue.component('details', {
        template: '#template-details',
        data: function () {
            return {
                curr_view: "",
                curr_filter: "",

                curr_view_title: "",
                curr_filter_title: "",

                filter_name: "",

                views: [],

                items: []
            }
        },
        created: function () {
            this.fetch_data()
        },
        watch: {
            '$route': 'fetch_data'
        },
        methods: {
            fetch_data: function () {
                var ctx = this;

                $("#mygraph").html("");

                loadJSON("/api/details", function (jsonData) {
                    var view = ctx.$route.params.view;
                    var filter = ctx.$route.params.filter;

                    ctx.views = jsonData.Views

                    if (view === ":view") {
                        router.push({ name: 'details', params: { view: ctx.views[0].name }})
                        return
                    }

                    ctx.curr_view = view;
                    ctx.curr_filter = filter;

                    var userId = ""
                    var dependencyId = ""
                    var serviceName = ""

                    if (view === "service") {
                        ctx.items = jsonData.Services
                        ctx.filter_name = "Service"

                        // service-view = view from the standpoint of service owner
                        serviceName = filter
                    } else if (view === "consumer") {
                        ctx.items = jsonData.Dependencies
                        ctx.filter_name = "Dependency"

                        // consumer-view = view from the standpoint of service consumer
                        userId = jsonData.UserId
                        dependencyId = filter === "all" ? "" : filter
                    } else if (view === "globalops"){
                        ctx.items = jsonData.Users
                        ctx.filter_name = "User"

                        // globalops-view = view from the standpoint of global IT ops
                        userId = filter
                    }

                    ctx.views.forEach(function(item) {
                        if (item.name === ctx.curr_view) {
                            ctx.curr_view_title = item.title
                        }
                    })

                    ctx.items.forEach(function(item) {
                        if (item.name === ctx.curr_filter) {
                            ctx.curr_filter_title = item.title
                        }
                    })

                    if (filter === ":filter") {
                        if (ctx.items.length > 0) {
                            router.push({name: 'details', params: {view: view, filter: ctx.items[0].name}})
                        }
                        return
                    }

                    drawChart(ctx.curr_view, userId, dependencyId, serviceName)
                }, function (err) {
                    console.log("/api/details not loaded with err:")
                    console.log(err)
                });
            }
        }
    })
</script>

<!--Template for /home-->
<script type="text/x-template" id="template-home">
    <div>
    <div class="row">
        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-primary pull-right">Available</span>
                    <h5>Services</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">4</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-primary pull-right">Available</span>
                    <h5>Contexts</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">8</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-primary pull-right">Global</span>
                    <h5>Clusters</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">2</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-primary pull-right">Global</span>
                    <h5>Rules</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">4</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-success pull-right">Owner</span>
                    <h5>Services</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">4</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-success pull-right">Owner</span>
                    <h5>Contexts</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">8</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>

        <div class="col-md-2">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <span class="label label-success pull-right">Me</span>
                    <h5>Dependencies</h5>
                </div>
                <div class="ibox-content">
                    <h1 class="no-margins">8</h1>
                    <!--<div class="stat-percent font-bold text-success">98% <i class="fa fa-bolt"></i></div>-->
                    <!--<small>Total views</small>-->
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <h5>Services Endpoints </h5>

                    <!--<div class="ibox-tools">-->
                    <!--<a class="collapse-link">-->
                    <!--<i class="fa fa-chevron-up"></i>-->
                    <!--</a>-->
                    <!--<a class="dropdown-toggle" data-toggle="dropdown" href="#">-->
                    <!--<i class="fa fa-wrench"></i>-->
                    <!--</a>-->
                    <!--<ul class="dropdown-menu dropdown-user">-->
                    <!--<li><a href="#">Config option 1</a>-->
                    <!--</li>-->
                    <!--<li><a href="#">Config option 2</a>-->
                    <!--</li>-->
                    <!--</ul>-->
                    <!--<a class="close-link">-->
                    <!--<i class="fa fa-times"></i>-->
                    <!--</a>-->
                    <!--</div>-->
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-9 m-b-xs">
                            Filter by:

                            <!-- Single button -->
                            <div class="btn-group m-l-sm">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Action <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Action</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li><a href="#">Separated link</a></li>
                                </ul>
                            </div>

                            <span class="m-l-xl">User: </span>
                            <!-- Single button -->
                            <div class="btn-group m-l-sm">
                                <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Action <span class="caret"></span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a href="#">Action</a></li>
                                    <li><a href="#">Another action</a></li>
                                    <li><a href="#">Something else here</a></li>
                                    <li role="separator" class="divider"></li>
                                    <li><a href="#">Separated link</a></li>
                                </ul>
                            </div>
                        </div>
                        <!--<div class="col-sm-9 m-b-xs">-->
                        <!--<div data-toggle="buttons" class="btn-group">-->
                        <!--<label class="btn btn-sm btn-white active"> <input type="radio" id="option-all" name="options"> All </label>-->
                        <!--<label class="btn btn-sm btn-white"> <input type="radio" id="option1" name="options"> Service 1 </label>-->
                        <!--<label class="btn btn-sm btn-white"> <input type="radio" id="option2" name="options"> Service 2 </label>-->
                        <!--<label class="btn btn-sm btn-white"> <input type="radio" id="option3" name="options"> Service 3 </label>-->
                        <!--</div>-->
                        <!--</div>-->
                        <!--<div class="col-sm-3">-->
                        <!--<div class="input-group"><input type="text" placeholder="Search" class="input-sm form-control"> <span class="input-group-btn">-->
                        <!--<button type="button" class="btn btn-sm btn-primary"> Go!</button> </span></div>-->
                        <!--</div>-->
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>

                                <th>Cluster </th>
                                <th>Service </th>
                                <th>Context </th>
                                <th>Allocation </th>
                                <th>Link </th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>Project <small>This is example of project</small></td>
                                <td>Patrick Smith</td>
                                <td>0800 051213</td>
                                <td>Inceptos Hymenaeos Ltd</td>
                                <td><a href="#"><i class="fa fa-check text-navy"></i></a></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

    </div>
    </div>
</script>

<!--JS for /home-->
<script>
    const CompHome = Vue.component('home', {
        template: '#template-home',
        data: function () {
            console.log("home#data()");
            return {
                counter: 0
            }
        },
        created: function () {
            console.log("home#created()");
            this.fetch_data()
        },
        watch: {
            '$route': 'fetch_data'
        },
        methods: {
            fetch_data: function () {
                console.log("home#methods#fetch_data");
                console.log(this.$route);
            }
        }
    });
</script>

<!--Main Vue JS-->
<script>
    const routes = [
        { name: 'home', path: '/home', title: "Home", component: CompHome },
        { name: 'details', path: '/details/:view/:filter', title: 'Details', component: CompDetails },
        { path: '*', redirect: { name: 'home' } }
    ];

    const router = new VueRouter({
        routes: routes,
        linkActiveClass: 'active',
        linkExactActiveClass: 'active'
    });

    const app = new Vue({
        el: '#wrapper',
        router: router,
        data: {
            routes: routes
        },
        computed: {
            user: function () {
                return {
                    name: Cookies.get("username")
                }
            }
        }
    });

</script>

</body>

</html>
