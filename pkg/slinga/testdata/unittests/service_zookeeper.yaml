# Service definition for Zookeeper
- metadata:
    kind: service
    namespace: main
    name: zookeeper

  owner: 1

  components:
    - name: component1
      code:
        type: aptomi/code/unittests
        params:
          cluster: cluster-us-west
      dependencies:
        - component2

    - name: component2
      code:
        type: aptomi/code/unittests
        params:
          cluster: cluster-us-west

# Contract
- metadata:
    kind: contract
    namespace: main
    name: zookeeper

  change-labels:
    set:
      x: y
    remove:
      z:

  contexts:
    # Context definition for prod (high priority)
    - name: prod-high

      criteria:
        require-all:
          - dev == "no" && prod == "yes" && priority >= 200
        require-any:
          - dev == "no"
          - prod == "yes"
          - priority >= 200
        require-none:
          - nozookeeper

      change-labels:
        set:
          some-test-context-specific-label: some-value
        remove:
          a:
          b:

      allocation:
        service: zookeeper
        keys:
          - "{{.User.Name}}"

    # Context definition for prod (low priority)
    - name: prod-low

      criteria:
        require-any:
          - dev == "no" && prod == "yes" && priority < 200
        require-none:
          - nozookeeper

      change-labels:
        set:
          prod-low-ctx: true
          prod-low-alloc: true
        remove:
          some-label-to-be-removed:

      allocation:
        service: zookeeper
        keys:
          - "team-{{.User.Labels.team}}"
          - "{{index .Labels \"prod-low-ctx\"}}"

    # Context definition for test
    - name: test

      criteria:
        require-all:
          - 10 > 5
          - 20 > 10
          - 100 > 50
        require-any:
          - dev == "yes" && prod == "no"
        require-none:
          - nozookeeper

      change-labels:
        set:
          some-test-context-specific-label: some-value
        remove:
          a:
          b:

      allocation:
        service: zookeeper
        keys:
          - "{{.User.Labels.team}}"
