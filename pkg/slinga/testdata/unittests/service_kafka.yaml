# Kafka
- metadata:
    kind: service
    namespace: main
    name: kafka

  owner: 1

  components:
    - name: component1
      contract: zookeeper

    - name: component2
      discovery:
        url: "kafka-{{ .Discovery.instance }}-url"
      code:
        type: aptomi/code/unittests
        params:
          cluster: cluster-us-east
          address: "{{ .Discovery.component1.component2.instance }}"
          queue: "{{ .User.Labels.changinglabel }}"
          someparam: "{{ index .Labels \"some-test-context-specific-label\" }}"
          secretparam: "{{ .User.Secrets.bigsecret }}"
          data1:
            param:
              name: value1
          data2:
            param:
              name: value2
          data3:
            param:
              name: value3
          data4:
            param:
              name: value4
          data5:
            param:
              name: value5
          data6:
            param:
              name: 123456789
          data7:
            param:
              name: true
          data8:
            param:
              name: false
      dependencies:
        - component1

# Contract
- metadata:
    kind: contract
    namespace: main
    name: kafka

  change-labels:
    set:
      x: y
    remove:
      z:

  contexts:
    # Context definition for prod (high priority)
    - name: prod-high

      criteria:
        require-all:
          - dev == "no" && prod == "yes" && priority >= 200
        require-any:
          - dev == "no"
          - prod == "yes"
          - priority >= 200

      change-labels:
        set:
          some-test-context-specific-label: some-value
        remove:
          a:
          b:

      allocation:
        service: kafka
        keys:
          - "{{.User.Name}}"

    # Context definition for prod (low priority)
    - name: prod-low

      criteria:
        require-any:
          - dev == "no" && prod == "yes" && priority < 200

      change-labels:
        set:
          prod-low-ctx: true
          prod-low-alloc: true
        remove:
          some-label-to-be-removed:

      allocation:
        service: kafka
        keys:
          - "team-{{.User.Labels.team}}"
          - "{{index .Labels \"prod-low-ctx\"}}"

    # Context definition for test
    - name: test

      criteria:
        require-all:
          - 10 > 5
          - 20 > 10
          - 100 > 50
        require-any:
          - dev == "yes" && prod == "no"

      change-labels:
        set:
          some-test-context-specific-label: some-value
        remove:
          a:
          b:

      allocation:
        service: kafka
        keys:
          - "{{.User.Labels.team}}"
